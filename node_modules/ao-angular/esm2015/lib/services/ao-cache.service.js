/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/ao-cache.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Md5 } from 'ts-md5';
// @Injectable({
//   providedIn: 'root'
// })
export class AOCacheService {
    /**
     * @param {?} _db
     * @param {?} _storage
     */
    constructor(_db, _storage) {
        this._db = _db;
        this._storage = _storage;
        this._configs = {
            type: 'full',
            // none|local|server|full
            expire: ((24 * 60 * 60) * 1000),
            metadata: {},
        };
    }
    /**
     * @param {?} params
     * @param {?} request
     * @param {?=} configs
     * @return {?}
     */
    find(params, request, configs = {}) {
        configs = (typeof configs === 'object') ? Object.assign({}, this._configs, configs) : Object.assign({}, this._configs);
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            params = JSON.stringify(params);
            /** @type {?} */
            const key = Md5.hashStr(params);
            /** @type {?} */
            const cached = yield this.get(key, configs);
            if (cached) {
                return resolve(cached);
            }
            request().then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                yield this.set(key, params, response, configs);
                return resolve(response);
            })));
        })));
    }
    /**
     * @param {?} key
     * @param {?} configs
     * @return {?}
     */
    get(key, configs) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            console.log('Cache::get', key);
            /** @type {?} */
            const response = this._storage.retrieve(key);
            /** @type {?} */
            const response_updated_at = this._storage.retrieve(key + '_updated_at');
            if (response != null
                && response_updated_at != null
                && (Date.now() - response_updated_at) <= configs.expire) {
                return JSON.parse(response);
            }
            return yield this.getInServer(key, configs);
        });
    }
    /**
     * @param {?} key
     * @param {?} configs
     * @return {?}
     */
    getInServer(key, configs) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            let cached = null;
            try {
                cached = yield this._db.query((/**
                 * @param {?} q
                 * @return {?}
                 */
                q => q.Get(q.Match(q.Index('cache_by_key'), key))));
            }
            catch (e) {
                return null;
            }
            this._storage.store(key, cached.data.response);
            this._storage.store(key + '_updated_at', cached.data.updated_at);
            if ((Date.now() - cached.data.updated_at) > configs.expire) {
                return null;
            }
            return JSON.parse(cached.data.response);
        });
    }
    /**
     * @param {?} key
     * @param {?} request
     * @param {?} response
     * @param {?} configs
     * @return {?}
     */
    set(key, request, response, configs) {
        /** @type {?} */
        const data = {
            key,
            request,
            response: JSON.stringify(response),
            updated_at: Date.now(),
            metadata: configs.metadata
        };
        this._storage.store(key, data.response);
        this._storage.store(key + '_updated_at', data.updated_at);
        return this.setInServer(key, data);
    }
    /**
     * @param {?} key
     * @param {?} data
     * @return {?}
     */
    setInServer(key, data) {
        return this._db.query((/**
         * @param {?} q
         * @return {?}
         */
        q => q.If(q.Exists(q.Match(q.Index('cache_by_key'), key)), q.Update(q.Select(['ref'], q.Get(q.Match(q.Index('cache_by_key'), key))), { data: Object.assign({}, data) }), q.Create(q.Collection('cache'), { data: Object.assign({}, data, { created_at: Date.now() }) }))));
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    AOCacheService.prototype._configs;
    /**
     * @type {?}
     * @private
     */
    AOCacheService.prototype._db;
    /**
     * @type {?}
     * @private
     */
    AOCacheService.prototype._storage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW8tY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FvLWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvYW8tY2FjaGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sUUFBUSxDQUFDOzs7O0FBTzdCLE1BQU0sT0FBTyxjQUFjOzs7OztJQVF6QixZQUNVLEdBQXFCLEVBQ3JCLFFBQTZCO1FBRDdCLFFBQUcsR0FBSCxHQUFHLENBQWtCO1FBQ3JCLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBUi9CLGFBQVEsR0FBUTtZQUN0QixJQUFJLEVBQUUsTUFBTTs7WUFDWixNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQy9CLFFBQVEsRUFBRSxFQUFFO1NBQ2IsQ0FBQztJQU1GLENBQUM7Ozs7Ozs7SUFFRCxJQUFJLENBQUMsTUFBVyxFQUFFLE9BQTJCLEVBQUUsVUFBZSxFQUFFO1FBRTlELE9BQU8sR0FBRyxDQUFDLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsbUJBQUssSUFBSSxDQUFDLFFBQVEsRUFBSyxPQUFPLEVBQUUsQ0FBQyxtQkFBSyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFOUYsT0FBTyxJQUFJLE9BQU87Ozs7O1FBQUMsQ0FBTyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFFM0MsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7O2tCQUMxQixHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7O2tCQUV6QixNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUM7WUFDM0MsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsT0FBTyxPQUFPLENBQUMsTUFBTSxD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O0lBQ3JDLENBQUM7Ozs7OztJQUVELFdBQVcsQ0FBQyxHQUFHLEVBQUUsSUFBSTtRQUNuQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FDN0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsRUFDL0MsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUMsSUFBSSxvQkFBTSxJQUFJLENBQUMsRUFBQyxDQUFDLEVBQzVGLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFDLElBQUksb0JBQU0sSUFBSSxJQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUMsRUFBQyxDQUFDLENBQzNFLEVBQUMsQ0FBQztJQUNMLENBQUM7Q0FFRjs7Ozs7O0lBN0ZDLGtDQUlFOzs7OztJQUdBLDZCQUE2Qjs7Ozs7SUFDN0Isa0NBQXFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnbmd4LXdlYnN0b3JhZ2UnO1xyXG5pbXBvcnQgeyBNZDUgfSBmcm9tICd0cy1tZDUnO1xyXG5cclxuaW1wb3J0IHsgQU9GYXVuYURiU2VydmljZSB9IGZyb20gJy4vYW8tZmF1bmEtZGIuc2VydmljZSc7XHJcblxyXG4vLyBASW5qZWN0YWJsZSh7XHJcbi8vICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbi8vIH0pXHJcbmV4cG9ydCBjbGFzcyBBT0NhY2hlU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgX2NvbmZpZ3M6IGFueSA9IHtcclxuICAgIHR5cGU6ICdmdWxsJywgLy8gbm9uZXxsb2NhbHxzZXJ2ZXJ8ZnVsbFxyXG4gICAgZXhwaXJlOiAoKDI0ICogNjAgKiA2MCkgKiAxMDAwKSxcclxuICAgIG1ldGFkYXRhOiB7fSxcclxuICB9O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgX2RiOiBBT0ZhdW5hRGJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBfc3RvcmFnZTogTG9jYWxTdG9yYWdlU2VydmljZSxcclxuICApIHtcclxuICB9XHJcblxyXG4gIGZpbmQocGFyYW1zOiBhbnksIHJlcXVlc3Q6ICgpID0+IFByb21pc2U8YW55PiwgY29uZmlnczogYW55ID0ge30pIHtcclxuXHJcbiAgICBjb25maWdzID0gKHR5cGVvZiBjb25maWdzID09PSAnb2JqZWN0JykgPyB7Li4udGhpcy5fY29uZmlncywgLi4uY29uZmlnc30gOiB7Li4udGhpcy5fY29uZmlnc307XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuXHJcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7XHJcbiAgICAgIGNvbnN0IGtleSA9IE1kNS5oYXNoU3RyKHBhcmFtcyk7XHJcblxyXG4gICAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCB0aGlzLmdldChrZXksIGNvbmZpZ3MpO1xyXG4gICAgICBpZiAoY2FjaGVkKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoY2FjaGVkKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmVxdWVzdCgpLnRoZW4oYXN5bmMgcmVzcG9uc2UgPT4ge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuc2V0KGtleSwgcGFyYW1zLCByZXNwb25zZSwgY29uZmlncyk7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzcG9uc2UpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldChrZXksIGNvbmZpZ3M6IGFueSkge1xyXG4gICAgY29uc29sZS5sb2coJ0NhY2hlOjpnZXQnLCBrZXkpO1xyXG5cclxuICAgIGNvbnN0IHJlc3BvbnNlID0gdGhpcy5fc3RvcmFnZS5yZXRyaWV2ZShrZXkpO1xyXG4gICAgY29uc3QgcmVzcG9uc2VfdXBkYXRlZF9hdCA9IHRoaXMuX3N0b3JhZ2UucmV0cmlldmUoa2V5ICsgJ191cGRhdGVkX2F0Jyk7XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICByZXNwb25zZSAhPSBudWxsXHJcbiAgICAgICYmIHJlc3BvbnNlX3VwZGF0ZWRfYXQgIT0gbnVsbFxyXG4gICAgICAmJiAoRGF0ZS5ub3coKSAtIHJlc3BvbnNlX3VwZGF0ZWRfYXQpIDw9IGNvbmZpZ3MuZXhwaXJlXHJcbiAgICApIHtcclxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UocmVzcG9uc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEluU2VydmVyKGtleSwgY29uZmlncyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRJblNlcnZlcihrZXksIGNvbmZpZ3M6IGFueSkge1xyXG4gICAgbGV0IGNhY2hlZCA9IG51bGw7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY2FjaGVkID0gYXdhaXQgdGhpcy5fZGIucXVlcnkocSA9PiBxLkdldChxLk1hdGNoKHEuSW5kZXgoJ2NhY2hlX2J5X2tleScpLCBrZXkpKSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX3N0b3JhZ2Uuc3RvcmUoa2V5LCBjYWNoZWQuZGF0YS5yZXNwb25zZSk7XHJcbiAgICB0aGlzLl9zdG9yYWdlLnN0b3JlKGtleSArICdfdXBkYXRlZF9hdCcsIGNhY2hlZC5kYXRhLnVwZGF0ZWRfYXQpO1xyXG5cclxuICAgIGlmICgoRGF0ZS5ub3coKSAtIGNhY2hlZC5kYXRhLnVwZGF0ZWRfYXQpID4gY29uZmlncy5leHBpcmUpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoY2FjaGVkLmRhdGEucmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgc2V0KGtleSwgcmVxdWVzdCwgcmVzcG9uc2UsIGNvbmZpZ3M6IGFueSkge1xyXG4gICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAga2V5LFxyXG4gICAgICByZXF1ZXN0LFxyXG4gICAgICByZXNwb25zZTogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpLFxyXG4gICAgICB1cGRhdGVkX2F0OiBEYXRlLm5vdygpLFxyXG4gICAgICBtZXRhZGF0YTogY29uZmlncy5tZXRhZGF0YVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLl9zdG9yYWdlLnN0b3JlKGtleSwgZGF0YS5yZXNwb25zZSk7XHJcbiAgICB0aGlzLl9zdG9yYWdlLnN0b3JlKGtleSArICdfdXBkYXRlZF9hdCcsIGRhdGEudXBkYXRlZF9hdCk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuc2V0SW5TZXJ2ZXIoa2V5LCBkYXRhKTtcclxuICB9XHJcblxyXG4gIHNldEluU2VydmVyKGtleSwgZGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2RiLnF1ZXJ5KHEgPT4gcS5JZihcclxuICAgICAgcS5FeGlzdHMocS5NYXRjaChxLkluZGV4KCdjYWNoZV9ieV9rZXknKSwga2V5KSksXHJcbiAgICAgIHEuVXBkYXRlKHEuU2VsZWN0KFsncmVmJ10sIHEuR2V0KHEuTWF0Y2gocS5JbmRleCgnY2FjaGVfYnlfa2V5JyksIGtleSkpKSwge2RhdGE6IHsuLi5kYXRhfX0pLFxyXG4gICAgICBxLkNyZWF0ZShxLkNvbGxlY3Rpb24oJ2NhY2hlJyksIHtkYXRhOiB7Li4uZGF0YSwgY3JlYXRlZF9hdDogRGF0ZS5ub3coKX19KVxyXG4gICAgKSk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=