/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/ao-auth-firebase.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Plugins, registerWebPlugin } from '@capacitor/core';
import { OAuth2Client } from '@byteowls/capacitor-oauth2';
import * as firebase from 'firebase/app';
import { AOAuthService } from './ao-auth.service';
import { AOFirebaseService } from './ao-firebase.service';
import { AOSubscriptions } from '../utils/ao-subscriptions';
import { AOEnvService } from './ao-env.service';
import * as i0 from "@angular/core";
import * as i1 from "./ao-auth.service";
import * as i2 from "./ao-firebase.service";
import * as i3 from "./ao-env.service";
export class AOAuthFirebaseService {
    /**
     * @param {?} _auth
     * @param {?} _fb
     * @param {?} _env
     */
    constructor(_auth, _fb, _env) {
        this._auth = _auth;
        this._fb = _fb;
        this._env = _env;
        this._subscriptions = new AOSubscriptions();
        registerWebPlugin(OAuth2Client);
        this._auth.provider(this);
        this._auth.isUser() ? this.authListening() : null;
    }
    // -------------------------------------------------------------------------------------------------------------------
    /**
     * @param {?} data
     * @return {?}
     */
    login(data) {
        this._subscriptions.stop();
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                /** @type {?} */
                let oauth = null;
                /** @type {?} */
                let credential = null;
                if (data.provider instanceof firebase.auth.GoogleAuthProvider) {
                    oauth = yield this.loginGoogle();
                    credential = firebase.auth.GoogleAuthProvider.credential(null, oauth.access_token);
                }
                else if (data.provider instanceof firebase.auth.FacebookAuthProvider) {
                    oauth = yield this.loginFacebook();
                    credential = firebase.auth.FacebookAuthProvider.credential(oauth.access_token);
                }
                else if (data.provider instanceof firebase.auth.TwitterAuthProvider) {
                    oauth = yield this.loginTwitter();
                    credential = firebase.auth.TwitterAuthProvider.credential(oauth.access_token, '');
                }
                else if (data.provider instanceof firebase.auth.GithubAuthProvider) {
                    oauth = yield this.loginGithub();
                    credential = firebase.auth.GithubAuthProvider.credential(oauth.access_token);
                }
                else {
                    reject('Invalid Auth Provider.');
                }
                /** @type {?} */
                const auth = yield this._fb.auth().auth.signInWithCredential(credential);
                /** @type {?} */
                const user = yield this.userCreateOrUpdate(auth.user, {
                    given_name: oauth.given_name,
                    family_name: oauth.family_name,
                    locale: oauth.locale,
                });
                resolve(user);
            }
            catch (e) {
                reject(e);
            }
        })));
        promise.finally((/**
         * @return {?}
         */
        () => this.authListening(true)));
        return promise;
    }
    /**
     * @return {?}
     */
    logout() {
        this._subscriptions.stop();
        return this._fb.firebase().destroy().then((/**
         * @return {?}
         */
        () => this._fb.conn().logout()));
    }
    /**
     * @param {?} data
     * @return {?}
     */
    update(data) {
        return Promise.resolve();
    }
    /**
     * @param {?} data
     * @return {?}
     */
    forgetPassword(data) {
        return Promise.resolve();
    }
    /**
     * @param {?} data
     * @return {?}
     */
    resetPassword(data) {
        return Promise.resolve();
    }
    /**
     * @param {?} data
     * @return {?}
     */
    updatePassword(data) {
        return Promise.resolve();
    }
    // -------------------------------------------------------------------------------------------------------------------
    /**
     * @private
     * @return {?}
     */
    loginGoogle() {
        return Plugins.OAuth2Client.authenticate({
            scope: 'email profile',
            authorizationBaseUrl: 'https://accounts.google.com/o/oauth2/auth',
            resourceUrl: 'https://www.googleapis.com/userinfo/v2/me',
            accessTokenEndpoint: 'https://www.googleapis.com/oauth2/v4/token',
            web: {
                appId: this._env.oauth.google.web,
                responseType: 'token',
                redirectUrl: this._env.app_url,
                accessTokenEndpoint: '',
                pkceEnable: false,
                windowOptions: 'height=500,left=0,top=0',
            },
            android: {
                appId: this._env.oauth.google.android,
                responseType: 'code',
                // if you configured a android app in google dev console the value must be "code"
                redirectUrl: this._env.app_id + ':/' // package name from google dev console
            },
            ios: {
                appId: this._env.oauth.google.ios,
                responseType: 'code',
                // if you configured a ios app in google dev console the value must be "code"
                redirectUrl: this._env.app_id + ':/' // Bundle ID from google dev console
            }
        });
    }
    /**
     * @private
     * @return {?}
     */
    loginFacebook() {
        return this.loginGoogle();
    }
    /**
     * @private
     * @return {?}
     */
    loginTwitter() {
        return this.loginGoogle();
    }
    /**
     * @private
     * @return {?}
     */
    loginGithub() {
        return this.loginGoogle();
    }
    /**
     * @private
     * @param {?=} skip
     * @return {?}
     */
    authListening(skip = false) {
        this._subscriptions.stop();
        this._subscriptions.auth = this._fb.authState().subscribe((/**
         * @param {?} auth
         * @return {?}
         */
        (auth) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (auth) {
                if (skip === false) {
                    skip = false;
                    yield this.userCreateOrUpdate(auth);
                }
                this._subscriptions.user = this._fb.fsDocSnapshot('/users/' + auth.uid).subscribe((/**
                 * @param {?} snapshot
                 * @return {?}
                 */
                snapshot => {
                    return snapshot.payload.exists
                        ? this._auth.setUser(snapshot.payload.data())
                        : this._auth.logout();
                }), (/**
                 * @return {?}
                 */
                () => {
                    console.warn('Oops! Failed to watch user.');
                }));
            }
            else {
                return this._auth.logout();
            }
        })), (/**
         * @return {?}
         */
        () => {
            console.warn('Oops! Failed to update authentication.');
        }));
    }
    /**
     * @private
     * @param {?} user
     * @param {?=} extra
     * @return {?}
     */
    userCreateOrUpdate(user, extra = {}) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const userRef = this._fb.fsDoc('/users/' + user.uid);
            /** @type {?} */
            const userDoc = yield userRef.ref.get();
            /** @type {?} */
            const data = Object.assign({}, userDoc.data(), { id: user.uid, email: user.email, email_verified: user.emailVerified, name: user.displayName, image: user.photoURL, logged_at: this._fb.fsNow() }, extra);
            if (!userDoc.exists) {
                data.active = true;
                data.created_at = this._fb.fsNow();
                data.updated_at = this._fb.fsNow();
                data.deleted_at = null;
            }
            yield userRef.set(data, { merge: true });
            return (yield userRef.ref.get()).data();
        });
    }
}
AOAuthFirebaseService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AOAuthFirebaseService.ctorParameters = () => [
    { type: AOAuthService },
    { type: AOFirebaseService },
    { type: undefined, decorators: [{ type: Inject, args: [AOEnvService,] }] }
];
/** @nocollapse */ AOAuthFirebaseService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AOAuthFirebaseService_Factory() { return new AOAuthFirebaseService(i0.ɵɵinject(i1.AOAuthService), i0.ɵɵinject(i2.AOFirebaseService), i0.ɵɵinject(i3.AOEnvService)); }, token: AOAuthFirebaseService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    AOAuthFirebaseService.prototype._subscriptions;
    /**
     * @type {?}
     * @private
     */
    AOAuthFirebaseService.prototype._auth;
    /**
     * @type {?}
     * @private
     */
    AOAuthFirebaseService.prototype._fb;
    /**
     * @type {?}
     * @private
     */
    AOAuthFirebaseService.prototype._env;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW8tYXV0aC1maXJlYmFzZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW8tYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9hby1hdXRoLWZpcmViYXNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdELE9BQU8sRUFBNkIsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFckYsT0FBTyxLQUFLLFFBQVEsTUFBTSxjQUFjLENBQUM7QUFFekMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7O0FBS2hELE1BQU0sT0FBTyxxQkFBcUI7Ozs7OztJQUloQyxZQUNVLEtBQW9CLEVBQ3BCLEdBQXNCLEVBQ0EsSUFBSTtRQUYxQixVQUFLLEdBQUwsS0FBSyxDQUFlO1FBQ3BCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ0EsU0FBSSxHQUFKLElBQUksQ0FBQTtRQUw1QixtQkFBYyxHQUEwQixJQUFJLGVBQWUsRUFBRSxDQUFDO1FBT3BFLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRWhDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3BELENB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eEI7WUFFRCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUMsS0FBSyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7WUFFdkMsT0FBTyxDQUFDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFDLENBQUM7S0FBQTs7O1lBdkxGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQVJRLGFBQWE7WUFFYixpQkFBaUI7NENBY3JCLE1BQU0sU0FBQyxZQUFZOzs7Ozs7OztJQUx0QiwrQ0FBc0U7Ozs7O0lBR3BFLHNDQUE0Qjs7Ozs7SUFDNUIsb0NBQThCOzs7OztJQUM5QixxQ0FBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGx1Z2lucywgcmVnaXN0ZXJXZWJQbHVnaW4gfSBmcm9tICdAY2FwYWNpdG9yL2NvcmUnO1xyXG5pbXBvcnQgeyBPQXV0aDJBdXRoZW50aWNhdGVPcHRpb25zLCBPQXV0aDJDbGllbnQgfSBmcm9tICdAYnl0ZW93bHMvY2FwYWNpdG9yLW9hdXRoMic7XHJcbmltcG9ydCB7IFVzZXIgfSBmcm9tICdmaXJlYmFzZSc7XHJcbmltcG9ydCAqIGFzIGZpcmViYXNlIGZyb20gJ2ZpcmViYXNlL2FwcCc7XHJcblxyXG5pbXBvcnQgeyBBT0F1dGhTZXJ2aWNlIH0gZnJvbSAnLi9hby1hdXRoLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBT0F1dGhQcm92aWRlckludGVyZmFjZSB9IGZyb20gJy4vYW8tYXV0aC1wcm92aWRlci5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBBT0ZpcmViYXNlU2VydmljZSB9IGZyb20gJy4vYW8tZmlyZWJhc2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IEFPU3Vic2NyaXB0aW9ucyB9IGZyb20gJy4uL3V0aWxzL2FvLXN1YnNjcmlwdGlvbnMnO1xyXG5pbXBvcnQgeyBBT0VudlNlcnZpY2UgfSBmcm9tICcuL2FvLWVudi5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIEFPQXV0aEZpcmViYXNlU2VydmljZSBpbXBsZW1lbnRzIEFPQXV0aFByb3ZpZGVySW50ZXJmYWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uczogQU9TdWJzY3JpcHRpb25zIHwgYW55ID0gbmV3IEFPU3Vic2NyaXB0aW9ucygpO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgX2F1dGg6IEFPQXV0aFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIF9mYjogQU9GaXJlYmFzZVNlcnZpY2UsXHJcbiAgICBASW5qZWN0KEFPRW52U2VydmljZSkgcHJpdmF0ZSBfZW52XHJcbiAgKSB7XHJcbiAgICByZWdpc3RlcldlYlBsdWdpbihPQXV0aDJDbGllbnQpO1xyXG5cclxuICAgIHRoaXMuX2F1dGgucHJvdmlkZXIodGhpcyk7XHJcbiAgICB0aGlzLl9hdXRoLmlzVXNlcigpID8gdGhpcy5hdXRoTGlzdGVuaW5nKCkgOiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuICBsb2dpbihkYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5zdG9wKCk7XHJcblxyXG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBsZXQgb2F1dGggPSBudWxsO1xyXG4gICAgICAgIGxldCBjcmVkZW50aWFsID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKGRhdGEucHJvdmlkZXIgaW5zdGFuY2VvZiBmaXJlYmFzZS5hdXRoLkdvb2dsZUF1dGhQcm92aWRlcikge1xyXG4gICAgICAgICAgb2F1dGggPSBhd2FpdCB0aGlzLmxvZ2luR29vZ2xlKCk7XHJcbiAgICAgICAgICBjcmVkZW50aWFsID0gZmlyZWJhc2UuYXV0aC5Hb29nbGVBdXRoUHJvdmlkZXIuY3JlZGVudGlhbChudWxsLCBvYXV0aC5hY2Nlc3NfdG9rZW4pO1xyXG5cclxuICAgICAgICB9IGVsc2UgaWYgKGRhdGEucHJvdmlkZXIgaW5zdGFuY2VvZiBmaXJlYmFzZS5hdXRoLkZhY2Vib29rQXV0aFByb3ZpZGVyKSB7XHJcbiAgICAgICAgICBvYXV0aCA9IGF3YWl0IHRoaXMubG9naW5GYWNlYm9vaygpO1xyXG4gICAgICAgICAgY3JlZGVudGlhbCA9IGZpcmViYXNlLmF1dGguRmFjZWJvb2tBdXRoUHJvdmlkZXIuY3JlZGVudGlhbChvYXV0aC5hY2Nlc3NfdG9rZW4pO1xyXG5cclxuICAgICAgICB9IGVsc2UgaWYgKGRhdGEucHJvdmlkZXIgaW5zdGFuY2VvZiBmaXJlYmFzZS5hdXRoLlR3aXR0ZXJBdXRoUHJvdmlkZXIpIHtcclxuICAgICAgICAgIG9hdXRoID0gYXdhaXQgdGhpcy5sb2dpblR3aXR0ZXIoKTtcclxuICAgICAgICAgIGNyZWRlbnRpYWwgPSBmaXJlYmFzZS5hdXRoLlR3aXR0ZXJBdXRoUHJvdmlkZXIuY3JlZGVudGlhbChvYXV0aC5hY2Nlc3NfdG9rZW4sICcnKTtcclxuXHJcbiAgICAgICAgfSBlbHNlIGlmIChkYXRhLnByb3ZpZGVyIGluc3RhbmNlb2YgZmlyZWJhc2UuYXV0aC5HaXRodWJBdXRoUHJvdmlkZXIpIHtcclxuICAgICAgICAgIG9hdXRoID0gYXdhaXQgdGhpcy5sb2dpbkdpdGh1YigpO1xyXG4gICAgICAgICAgY3JlZGVudGlhbCA9IGZpcmViYXNlLmF1dGguR2l0aHViQXV0aFByb3ZpZGVyLmNyZWRlbnRpYWwob2F1dGguYWNjZXNzX3Rva2VuKTtcclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlamVjdCgnSW52YWxpZCBBdXRoIFByb3ZpZGVyLicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgYXV0aCA9IGF3YWl0IHRoaXMuX2ZiLmF1dGgoKS5hdXRoLnNpZ25JbldpdGhDcmVkZW50aWFsKGNyZWRlbnRpYWwpO1xyXG5cclxuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyQ3JlYXRlT3JVcGRhdGUoYXV0aC51c2VyLCB7XHJcbiAgICAgICAgICBnaXZlbl9uYW1lOiBvYXV0aC5naXZlbl9uYW1lLFxyXG4gICAgICAgICAgZmFtaWx5X25hbWU6IG9hdXRoLmZhbWlseV9uYW1lLFxyXG4gICAgICAgICAgbG9jYWxlOiBvYXV0aC5sb2NhbGUsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlc29sdmUodXNlcik7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICB9KTtcclxuXHJcbiAgICBwcm9taXNlLmZpbmFsbHkoKCkgPT4gdGhpcy5hdXRoTGlzdGVuaW5nKHRydWUpKTtcclxuXHJcbiAgICByZXR1cm4gcHJvbWlzZTtcclxuICB9XHJcblxyXG4gIGxvZ291dCgpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5zdG9wKCk7XHJcbiAgICByZXR1cm4gdGhpcy5fZmIuZmlyZWJhc2UoKS5kZXN0cm95KCkudGhlbigoKSA9PiB0aGlzLl9mYi5jb25uKCkubG9nb3V0KCkpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlKGRhdGE6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgfVxyXG5cclxuICBmb3JnZXRQYXNzd29yZChkYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRQYXNzd29yZChkYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlUGFzc3dvcmQoZGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICB9XHJcblxyXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgcHJpdmF0ZSBsb2dpbkdvb2dsZSgpOiBPQXV0aDJBdXRoZW50aWNhdGVPcHRpb25zIHtcclxuICAgIHJldHVybiBQbHVnaW5zLk9BdXRoMkNsaWVudC5hdXRoZW50aWNhdGUoe1xyXG4gICAgICBzY29wZTogJ2VtYWlsIHByb2ZpbGUnLFxyXG4gICAgICBhdXRob3JpemF0aW9uQmFzZVVybDogJ2h0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoJyxcclxuICAgICAgcmVzb3VyY2VVcmw6ICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS91c2VyaW5mby92Mi9tZScsXHJcbiAgICAgIGFjY2Vzc1Rva2VuRW5kcG9pbnQ6ICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjQvdG9rZW4nLFxyXG4gICAgICB3ZWI6IHtcclxuICAgICAgICBhcHBJZDogdGhpcy5fZW52Lm9hdXRoLmdvb2dsZS53ZWIsXHJcbiAgICAgICAgcmVzcG9uc2VUeXBlOiAndG9rZW4nLFxyXG4gICAgICAgIHJlZGlyZWN0VXJsOiB0aGlzLl9lbnYuYXBwX3VybCxcclxuICAgICAgICBhY2Nlc3NUb2tlbkVuZHBvaW50OiAnJyxcclxuICAgICAgICBwa2NlRW5hYmxlOiBmYWxzZSxcclxuICAgICAgICB3aW5kb3dPcHRpb25zOiAnaGVpZ2h0PTUwMCxsZWZ0PTAsdG9wPTAnLFxyXG4gICAgICB9LFxyXG4gICAgICBhbmRyb2lkOiB7XHJcbiAgICAgICAgYXBwSWQ6IHRoaXMuX2Vudi5vYXV0aC5nb29nbGUuYW5kcm9pZCxcclxuICAgICAgICByZXNwb25zZVR5cGU6ICdjb2RlJywgLy8gaWYgeW91IGNvbmZpZ3VyZWQgYSBhbmRyb2lkIGFwcCBpbiBnb29nbGUgZGV2IGNvbnNvbGUgdGhlIHZhbHVlIG11c3QgYmUgXCJjb2RlXCJcclxuICAgICAgICByZWRpcmVjdFVybDogdGhpcy5fZW52LmFwcF9pZCArICc6LycgLy8gcGFja2FnZSBuYW1lIGZyb20gZ29vZ2xlIGRldiBjb25zb2xlXHJcbiAgICAgIH0sXHJcbiAgICAgIGlvczoge1xyXG4gICAgICAgIGFwcElkOiB0aGlzLl9lbnYub2F1dGguZ29vZ2xlLmlvcyxcclxuICAgICAgICByZXNwb25zZVR5cGU6ICdjb2RlJywgLy8gaWYgeW91IGNvbmZpZ3VyZWQgYSBpb3MgYXBwIGluIGdvb2dsZSBkZXYgY29uc29sZSB0aGUgdmFsdWUgbXVzdCBiZSBcImNvZGVcIlxyXG4gICAgICAgIHJlZGlyZWN0VXJsOiB0aGlzLl9lbnYuYXBwX2lkICsgJzovJyAvLyBCdW5kbGUgSUQgZnJvbSBnb29nbGUgZGV2IGNvbnNvbGVcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxvZ2luRmFjZWJvb2soKTogT0F1dGgyQXV0aGVudGljYXRlT3B0aW9ucyB7XHJcbiAgICByZXR1cm4gdGhpcy5sb2dpbkdvb2dsZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBsb2dpblR3aXR0ZXIoKTogT0F1dGgyQXV0aGVudGljYXRlT3B0aW9ucyB7XHJcbiAgICByZXR1cm4gdGhpcy5sb2dpbkdvb2dsZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBsb2dpbkdpdGh1YigpOiBPQXV0aDJBdXRoZW50aWNhdGVPcHRpb25zIHtcclxuICAgIHJldHVybiB0aGlzLmxvZ2luR29vZ2xlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGF1dGhMaXN0ZW5pbmcoc2tpcCA9IGZhbHNlKSB7XHJcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLnN0b3AoKTtcclxuXHJcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmF1dGggPSB0aGlzLl9mYi5hdXRoU3RhdGUoKS5zdWJzY3JpYmUoYXN5bmMgKGF1dGgpID0+IHtcclxuICAgICAgaWYgKGF1dGgpIHtcclxuICAgICAgICBpZiAoc2tpcCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIHNraXAgPSBmYWxzZTtcclxuICAgICAgICAgIGF3YWl0IHRoaXMudXNlckNyZWF0ZU9yVXBkYXRlKGF1dGgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy51c2VyID0gdGhpcy5fZmIuZnNEb2NTbmFwc2hvdCgnL3VzZXJzLycgKyBhdXRoLnVpZCkuc3Vic2NyaWJlKHNuYXBzaG90ID0+IHtcclxuXHJcbiAgICAgICAgICByZXR1cm4gc25hcHNob3QucGF5bG9hZC5leGlzdHNcclxuICAgICAgICAgICAgPyB0aGlzLl9hdXRoLnNldFVzZXIoc25hcHNob3QucGF5bG9hZC5kYXRhKCkpXHJcbiAgICAgICAgICAgIDogdGhpcy5fYXV0aC5sb2dvdXQoKTtcclxuXHJcbiAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS53YXJuKCdPb3BzISBGYWlsZWQgdG8gd2F0Y2ggdXNlci4nKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2F1dGgubG9nb3V0KCk7XHJcbiAgICAgIH1cclxuICAgIH0sICgpID0+IHtcclxuICAgICAgY29uc29sZS53YXJuKCdPb3BzISBGYWlsZWQgdG8gdXBkYXRlIGF1dGhlbnRpY2F0aW9uLicpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHVzZXJDcmVhdGVPclVwZGF0ZSh1c2VyOiBVc2VyLCBleHRyYSA9IHt9KSB7XHJcbiAgICBjb25zdCB1c2VyUmVmID0gdGhpcy5fZmIuZnNEb2MoJy91c2Vycy8nICsgdXNlci51aWQpO1xyXG4gICAgY29uc3QgdXNlckRvYyA9IGF3YWl0IHVzZXJSZWYucmVmLmdldCgpO1xyXG5cclxuICAgIGNvbnN0IGRhdGE6IGFueSA9IHtcclxuICAgICAgLi4udXNlckRvYy5kYXRhKCksXHJcbiAgICAgIGlkOiB1c2VyLnVpZCxcclxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXHJcbiAgICAgIGVtYWlsX3ZlcmlmaWVkOiB1c2VyLmVtYWlsVmVyaWZpZWQsXHJcbiAgICAgIG5hbWU6IHVzZXIuZGlzcGxheU5hbWUsXHJcbiAgICAgIGltYWdlOiB1c2VyLnBob3RvVVJMLFxyXG4gICAgICBsb2dnZWRfYXQ6IHRoaXMuX2ZiLmZzTm93KCksXHJcbiAgICAgIC4uLmV4dHJhXHJcbiAgICB9O1xyXG5cclxuICAgIGlmICghdXNlckRvYy5leGlzdHMpIHtcclxuICAgICAgZGF0YS5hY3RpdmUgPSB0cnVlO1xyXG4gICAgICBkYXRhLmNyZWF0ZWRfYXQgPSB0aGlzLl9mYi5mc05vdygpO1xyXG4gICAgICBkYXRhLnVwZGF0ZWRfYXQgPSB0aGlzLl9mYi5mc05vdygpO1xyXG4gICAgICBkYXRhLmRlbGV0ZWRfYXQgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGF3YWl0IHVzZXJSZWYuc2V0KGRhdGEsIHttZXJnZTogdHJ1ZX0pO1xyXG5cclxuICAgIHJldHVybiAoYXdhaXQgdXNlclJlZi5yZWYuZ2V0KCkpLmRhdGEoKTtcclxuICB9XHJcblxyXG4gIC8vIHJlZnJlc2hUb2tlbjogc3RyaW5nO1xyXG5cclxuICAvLyBvbk9BdXRoUmVmcmVzaEJ0bkNsaWNrKCkge1xyXG4gIC8vICAgaWYgKCF0aGlzLnJlZnJlc2hUb2tlbikge1xyXG4gIC8vICAgICBjb25zb2xlLmVycm9yKCdObyByZWZyZXNoIHRva2VuIGZvdW5kLiBMb2cgaW4gd2l0aCBPQXV0aCBmaXJzdC4nKTtcclxuICAvLyAgIH1cclxuICAvLyAgIFBsdWdpbnMuT0F1dGgyQ2xpZW50LnJlZnJlc2hUb2tlbihcclxuICAvLyAgICAge30gYXMgT0F1dGgyUmVmcmVzaFRva2VuT3B0aW9uc1xyXG4gIC8vICAgKS50aGVuKChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgLy8gICAgIGNvbnNvbGUubG9nKCdvbk9BdXRoUmVmcmVzaEJ0bkNsaWNrJywgcmVzcG9uc2UpO1xyXG4gIC8vICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xyXG4gIC8vICAgICBjb25zb2xlLmVycm9yKCdvbk9BdXRoUmVmcmVzaEJ0bkNsaWNrOmVycm9yJywgZXJyb3IpO1xyXG4gIC8vICAgfSk7XHJcbiAgLy8gfVxyXG5cclxuICAvLyBvbkxvZ291dENsaWNrKCkge1xyXG4gIC8vICAgUGx1Z2lucy5PQXV0aDJDbGllbnQubG9nb3V0KFxyXG4gIC8vICAgICB7fSBhcyBPQXV0aDJBdXRoZW50aWNhdGVPcHRpb25zXHJcbiAgLy8gICApLnRoZW4oKHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAvLyAgICAgY29uc29sZS5sb2coJ29uTG9nb3V0Q2xpY2snLCByZXNwb25zZSk7XHJcbiAgLy8gICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgLy8gICAgIGNvbnNvbGUuZXJyb3IoJ29uTG9nb3V0Q2xpY2s6ZXJyb3InLCBlcnJvcik7XHJcbiAgLy8gICB9KTtcclxuICAvLyB9XHJcblxyXG59XHJcbiJdfQ==