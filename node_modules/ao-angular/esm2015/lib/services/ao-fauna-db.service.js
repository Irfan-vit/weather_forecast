/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/ao-fauna-db.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { EventEmitter, Inject, Injectable } from '@angular/core';
import { LocalStorageService } from 'ngx-webstorage';
import * as FaunaDB from 'faunadb';
import { AOService } from './ao.service';
import { AOEnvService } from './ao-env.service';
import { AOCacheService } from './ao-cache.service';
import * as i0 from "@angular/core";
import * as i1 from "./ao.service";
import * as i2 from "ngx-webstorage";
import * as i3 from "./ao-env.service";
/** @type {?} */
const _q = FaunaDB.query;
// @dynamic
export class AOFaunaDbService {
    // -------------------------------------------------------------------------------------------------------------------
    /**
     * @param {?} _ao
     * @param {?} _storage
     * @param {?} _environment
     */
    constructor(_ao, _storage, _environment) {
        this._ao = _ao;
        this._storage = _storage;
        this._environment = _environment;
        this.q = _q;
        this._observer = new EventEmitter();
        this._cache = new AOCacheService(this, this._storage);
        this._client = new FaunaDB.Client({
            secret: this._environment.faunadb.secret,
            observer: (/**
             * @param {?} res
             * @return {?}
             */
            (res) => this._observer.emit(res))
        });
    }
    /**
     * @return {?}
     */
    client() {
        return this._client;
    }
    //--------------------------------------------------------------------------------------------------------------------
    // EXPRESSION
    //--------------------------------------------------------------------------------------------------------------------
    /**
     * @param {?} table
     * @param {?=} id
     * @return {?}
     */
    Ref(table, id) {
        return id ? _q.Ref(_q.Collection(table), id) : null;
    }
    /**
     * @param {?} table
     * @param {?} id
     * @return {?}
     */
    Get(table, id) {
        return _q.Get(_q.Ref(_q.Collection(table), id));
    }
    /**
     * @param {?} table
     * @param {?} data
     * @param {?=} id
     * @return {?}
     */
    Create(table, data, id = null) {
        return _q.Let({
            id: id ? id : _q.NewId()
        }, _q.Create(_q.Ref(_q.Collection(table), _q.Var('id')), {
            data: Object.assign({ is_activated: true }, data, { id: _q.Var('id'), created_at: Date.now(), updated_at: Date.now(), deleted_at: null })
        }));
    }
    /**
     * @param {?} table
     * @param {?} data
     * @param {?} id
     * @return {?}
     */
    Update(table, data, id) {
        return _q.Update(_q.Ref(_q.Collection(table), id), {
            data: Object.assign({}, data, { id, updated_at: Date.now() })
        });
    }
    /**
     * @param {?} table
     * @param {?} id
     * @return {?}
     */
    Delete(table, id) {
        return _q.Delete(_q.Ref(_q.Collection(table), id));
    }
    //--------------------------------------------------------------------------------------------------------------------
    // RESOURCES
    //--------------------------------------------------------------------------------------------------------------------
    /**
     * @param {?} callback
     * @param {?=} configs
     * @return {?}
     */
    query(callback, configs = {}) {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const params = callback(_q);
            /** @type {?} */
            const request = configs.cache
                ? this._cache.find(params, (/**
                 * @return {?}
                 */
                () => this.client().query(params)), configs.cache)
                : this.client().query(params);
            request.then((/**
             * @param {?} response
             * @return {?}
             */
            response => resolve(response)), (/**
             * @param {?} error
             * @return {?}
             */
            error => reject(error)));
        })));
        return this._ao.wait(promise);
    }
    /**
     * @return {?}
     */
    id() {
        return this.query((/**
         * @param {?} q
         * @return {?}
         */
        q => q.NewId()));
    }
    /**
     * @param {?} table
     * @param {?} id
     * @return {?}
     */
    find(table, id) {
        return this.query((/**
         * @return {?}
         */
        () => this.Get(table, id)));
    }
    /**
     * @param {?} table
     * @param {?} data
     * @param {?=} id
     * @return {?}
     */
    insert(table, data, id = null) {
        return this.query((/**
         * @return {?}
         */
        () => this.Create(table, data, id)));
    }
    /**
     * @param {?} table
     * @param {?} data
     * @param {?} id
     * @return {?}
     */
    upgrade(table, data, id) {
        return this.query((/**
         * @return {?}
         */
        () => this.Update(table, data, id)));
    }
    /**
     * @param {?} table
     * @param {?} data
     * @return {?}
     */
    save(table, data) {
        return data.id
            ? this.upgrade(table, data, data.id)
            : this.insert(table, data);
    }
    /**
     * @param {?} table
     * @param {?} id
     * @return {?}
     */
    destroy(table, id) {
        return this.query((/**
         * @return {?}
         */
        () => this.Delete(table, id)));
    }
}
AOFaunaDbService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AOFaunaDbService.ctorParameters = () => [
    { type: AOService },
    { type: LocalStorageService },
    { type: undefined, decorators: [{ type: Inject, args: [AOEnvService,] }] }
];
/** @nocollapse */ AOFaunaDbService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AOFaunaDbService_Factory() { return new AOFaunaDbService(i0.ɵɵinject(i1.AOService), i0.ɵɵinject(i2.LocalStorageService), i0.ɵɵinject(i3.AOEnvService)); }, token: AOFaunaDbService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    AOFaunaDbService.prototype._client;
    /**
     * @type {?}
     * @private
     */
    AOFaunaDbService.prototype._cache;
    /** @type {?} */
    AOFaunaDbService.prototype.q;
    /** @type {?} */
    AOFaunaDbService.prototype._observer;
    /**
     * @type {?}
     * @private
     */
    AOFaunaDbService.prototype._ao;
    /**
     * @type {?}
     * @private
     */
    AOFaunaDbService.prototype._storage;
    /**
     * @type {?}
     * @private
     */
    AOFaunaDbService.prototype._environment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW8tZmF1bmEtZGIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FvLWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvYW8tZmF1bmEtZGIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckQsT0FBTyxLQUFLLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFFbkMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDOzs7Ozs7TUFFOUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxLQUFLOztBQU94QixNQUFNLE9BQU8sZ0JBQWdCOzs7Ozs7O0lBWTNCLFlBQ1UsR0FBYyxFQUNkLFFBQTZCLEVBQ1AsWUFBWTtRQUZsQyxRQUFHLEdBQUgsR0FBRyxDQUFXO1FBQ2QsYUFBUSxHQUFSLFFBQVEsQ0FBcUI7UUFDUCxpQkFBWSxHQUFaLFlBQVksQ0FBQTtRQVQ1QixNQUFDLEdBQUcsRUFBRSxDQUFDO1FBRVAsY0FBUyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFTbEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ2hDLE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNO1lBQ3hDLFFBQVE7Ozs7WUFBRSxDQUFDLEdBQVEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFNB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LEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDOzs7Ozs7SUFFRCxPQUFPLENBQUMsS0FBYSxFQUFFLEVBQUU7UUFDdkIsT0FBTyxJQUFJLENBQUMsS0FBSzs7O1FBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUMsQ0FBQztJQUNsRCxDQUFDOzs7WUEvSEYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7O1lBVlEsU0FBUztZQUhULG1CQUFtQjs0Q0E2QnZCLE1BQU0sU0FBQyxZQUFZOzs7Ozs7OztJQWJ0QixtQ0FBeUM7Ozs7O0lBRXpDLGtDQUF3Qzs7SUFFeEMsNkJBQXVCOztJQUV2QixxQ0FBb0Q7Ozs7O0lBS2xELCtCQUFzQjs7Ozs7SUFDdEIsb0NBQXFDOzs7OztJQUNyQyx3Q0FBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnbmd4LXdlYnN0b3JhZ2UnO1xyXG5pbXBvcnQgKiBhcyBGYXVuYURCIGZyb20gJ2ZhdW5hZGInO1xyXG5cclxuaW1wb3J0IHsgQU9TZXJ2aWNlIH0gZnJvbSAnLi9hby5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQU9FbnZTZXJ2aWNlIH0gZnJvbSAnLi9hby1lbnYuc2VydmljZSc7XHJcbmltcG9ydCB7IEFPQ2FjaGVTZXJ2aWNlIH0gZnJvbSAnLi9hby1jYWNoZS5zZXJ2aWNlJztcclxuXHJcbmNvbnN0IF9xID0gRmF1bmFEQi5xdWVyeTtcclxuXHJcbi8vIEBkeW5hbWljXHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBBT0ZhdW5hRGJTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfY2xpZW50OiBGYXVuYURCLkNsaWVudDtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfY2FjaGU6IEFPQ2FjaGVTZXJ2aWNlO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgcSA9IF9xO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgX29ic2VydmVyID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIF9hbzogQU9TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBfc3RvcmFnZTogTG9jYWxTdG9yYWdlU2VydmljZSxcclxuICAgIEBJbmplY3QoQU9FbnZTZXJ2aWNlKSBwcml2YXRlIF9lbnZpcm9ubWVudFxyXG4gICkge1xyXG4gICAgdGhpcy5fY2FjaGUgPSBuZXcgQU9DYWNoZVNlcnZpY2UodGhpcywgdGhpcy5fc3RvcmFnZSk7XHJcbiAgICB0aGlzLl9jbGllbnQgPSBuZXcgRmF1bmFEQi5DbGllbnQoe1xyXG4gICAgICBzZWNyZXQ6IHRoaXMuX2Vudmlyb25tZW50LmZhdW5hZGIuc2VjcmV0LFxyXG4gICAgICBvYnNlcnZlcjogKHJlczogYW55KSA9PiB0aGlzLl9vYnNlcnZlci5lbWl0KHJlcylcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY2xpZW50KCk6IEZhdW5hREIuQ2xpZW50IHtcclxuICAgIHJldHVybiB0aGlzLl9jbGllbnQ7XHJcbiAgfVxyXG5cclxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgLy8gRVhQUkVTU0lPTlxyXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgUmVmKHRhYmxlOiBzdHJpbmcsIGlkPyk6IEZhdW5hREIuRXhwciB7XHJcbiAgICByZXR1cm4gaWQgPyBfcS5SZWYoX3EuQ29sbGVjdGlvbih0YWJsZSksIGlkKSA6IG51bGw7XHJcbiAgfVxyXG5cclxuICBHZXQodGFibGU6IHN0cmluZywgaWQ6IGFueSk6IEZhdW5hREIuRXhwciB7XHJcbiAgICByZXR1cm4gX3EuR2V0KF9xLlJlZihfcS5Db2xsZWN0aW9uKHRhYmxlKSwgaWQpKTtcclxuICB9XHJcblxyXG4gIENyZWF0ZSh0YWJsZTogc3RyaW5nLCBkYXRhOiBhbnksIGlkID0gbnVsbCk6IEZhdW5hREIuRXhwciB7XHJcbiAgICByZXR1cm4gX3EuTGV0KFxyXG4gICAgICB7XHJcbiAgICAgICAgaWQ6IGlkID8gaWQgOiBfcS5OZXdJZCgpXHJcbiAgICAgIH0sXHJcbiAgICAgIF9xLkNyZWF0ZShcclxuICAgICAgICBfcS5SZWYoX3EuQ29sbGVjdGlvbih0YWJsZSksIF9xLlZhcignaWQnKSksXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICBpc19hY3RpdmF0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgIC4uLmRhdGEsXHJcbiAgICAgICAgICAgIGlkOiBfcS5WYXIoJ2lkJyksXHJcbiAgICAgICAgICAgIGNyZWF0ZWRfYXQ6IERhdGUubm93KCksXHJcbiAgICAgICAgICAgIHVwZGF0ZWRfYXQ6IERhdGUubm93KCksXHJcbiAgICAgICAgICAgIGRlbGV0ZWRfYXQ6IG51bGxcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBVcGRhdGUodGFibGU6IHN0cmluZywgZGF0YTogYW55LCBpZDogYW55KTogRmF1bmFEQi5FeHByIHtcclxuICAgIHJldHVybiBfcS5VcGRhdGUoXHJcbiAgICAgIF9xLlJlZihfcS5Db2xsZWN0aW9uKHRhYmxlKSwgaWQpLFxyXG4gICAgICB7XHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgLi4uZGF0YSxcclxuICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgdXBkYXRlZF9hdDogRGF0ZS5ub3coKVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIERlbGV0ZSh0YWJsZTogc3RyaW5nLCBpZDogYW55KTogRmF1bmFEQi5FeHByIHtcclxuICAgIHJldHVybiBfcS5EZWxldGUoXHJcbiAgICAgIF9xLlJlZihfcS5Db2xsZWN0aW9uKHRhYmxlKSwgaWQpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gIC8vIFJFU09VUkNFU1xyXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgcXVlcnkoY2FsbGJhY2s6IChxKSA9PiBGYXVuYURCLkV4cHIsIGNvbmZpZ3M6IGFueSA9IHt9KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblxyXG4gICAgICBjb25zdCBwYXJhbXMgPSBjYWxsYmFjayhfcSk7XHJcblxyXG4gICAgICBjb25zdCByZXF1ZXN0ID0gY29uZmlncy5jYWNoZVxyXG4gICAgICAgID8gdGhpcy5fY2FjaGUuZmluZChwYXJhbXMsICgpID0+IHRoaXMuY2xpZW50KCkucXVlcnkocGFyYW1zKSwgY29uZmlncy5jYWNoZSlcclxuICAgICAgICA6IHRoaXMuY2xpZW50KCkucXVlcnkocGFyYW1zKTtcclxuXHJcbiAgICAgIHJlcXVlc3QudGhlbihyZXNwb25zZSA9PiByZXNvbHZlKHJlc3BvbnNlKSwgZXJyb3IgPT4gcmVqZWN0KGVycm9yKSk7XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuX2FvLndhaXQocHJvbWlzZSk7XHJcbiAgfVxyXG5cclxuICBpZCgpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIHRoaXMucXVlcnkocSA9PiBxLk5ld0lkKCkpO1xyXG4gIH1cclxuXHJcbiAgZmluZCh0YWJsZTogc3RyaW5nLCBpZDogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLnF1ZXJ5KCgpID0+IHRoaXMuR2V0KHRhYmxlLCBpZCkpO1xyXG4gIH1cclxuXHJcbiAgaW5zZXJ0KHRhYmxlOiBzdHJpbmcsIGRhdGE6IGFueSwgaWQgPSBudWxsKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLnF1ZXJ5KCgpID0+IHRoaXMuQ3JlYXRlKHRhYmxlLCBkYXRhLCBpZCkpO1xyXG4gIH1cclxuXHJcbiAgdXBncmFkZSh0YWJsZTogc3RyaW5nLCBkYXRhOiBhbnksIGlkKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLnF1ZXJ5KCgpID0+IHRoaXMuVXBkYXRlKHRhYmxlLCBkYXRhLCBpZCkpO1xyXG4gIH1cclxuXHJcbiAgc2F2ZSh0YWJsZTogc3RyaW5nLCBkYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIGRhdGEuaWRcclxuICAgICAgPyB0aGlzLnVwZ3JhZGUodGFibGUsIGRhdGEsIGRhdGEuaWQpXHJcbiAgICAgIDogdGhpcy5pbnNlcnQodGFibGUsIGRhdGEpO1xyXG4gIH1cclxuXHJcbiAgZGVzdHJveSh0YWJsZTogc3RyaW5nLCBpZCk6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5xdWVyeSgoKSA9PiB0aGlzLkRlbGV0ZSh0YWJsZSwgaWQpKTtcclxuICB9XHJcblxyXG59XHJcblxyXG4vLyBwcml2YXRlIHN0YXRpYyBfb2JzZXJ2ZXIoKSB7XHJcbi8vICAgcmV0dXJuIChyZXM6IGFueSkgPT4ge1xyXG4vL1xyXG4vLyAgICAgY29uc3QgZHQgPSBuZXcgRGF0ZSgpO1xyXG4vLyAgICAgY29uc3QgcHJlZml4ID0gW2R0LmdldFVUQ0Z1bGxZZWFyKCksIGR0LmdldFVUQ01vbnRoKCkgKyAxLCBkdC5nZXRVVENEYXRlKCldLmpvaW4oJy0nKTtcclxuLy9cclxuLy8gICAgIFsneC1yZWFkLW9wcycsICd4LXdyaXRlLW9wcyddLmZvckVhY2goKGhlYWRlcikgPT4ge1xyXG4vL1xyXG4vLyAgICAgICBsZXQgcXQgPSBwYXJzZUludChyZXMucmVzcG9uc2VIZWFkZXJzW2hlYWRlcl0sIDEwKTtcclxuLy8gICAgICAgcXQgPSBpc05hTihxdCkgPyAwIDogcXQ7XHJcbi8vXHJcbi8vICAgICAgIGhlYWRlciA9IHByZWZpeCArICctJyArIGhlYWRlcjtcclxuLy9cclxuLy8gICAgICAgbGV0IGNvdW50ZXIgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShoZWFkZXIpLCAxMCk7XHJcbi8vICAgICAgIGNvdW50ZXIgPSBpc05hTihjb3VudGVyKSA/IDAgOiBjb3VudGVyO1xyXG4vLyAgICAgICBjb3VudGVyICs9IHF0O1xyXG4vL1xyXG4vLyAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShoZWFkZXIsIGNvdW50ZXIudG9TdHJpbmcoKSk7XHJcbi8vXHJcbi8vICAgICB9KTtcclxuLy9cclxuLy8gICB9O1xyXG4vLyB9XHJcbiJdfQ==