/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/ao-cache.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Md5 } from 'ts-md5';
// @Injectable({
//   providedIn: 'root'
// })
var 
// @Injectable({
//   providedIn: 'root'
// })
AOCacheService = /** @class */ (function () {
    function AOCacheService(_db, _storage) {
        this._db = _db;
        this._storage = _storage;
        this._configs = {
            type: 'full',
            // none|local|server|full
            expire: ((24 * 60 * 60) * 1000),
            metadata: {},
        };
    }
    /**
     * @param {?} params
     * @param {?} request
     * @param {?=} configs
     * @return {?}
     */
    AOCacheService.prototype.find = /**
     * @param {?} params
     * @param {?} request
     * @param {?=} configs
     * @return {?}
     */
    function (params, request, configs) {
        var _this = this;
        if (configs === void 0) { configs = {}; }
        configs = (typeof configs === 'object') ? tslib_1.__assign({}, this._configs, configs) : tslib_1.__assign({}, this._configs);
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
            var key, cached;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        params = JSON.stringify(params);
                        key = Md5.hashStr(params);
                        return [4 /*yield*/, this.get(key, configs)];
                    case 1:
                        cached = _a.sent();
                        if (cached) {
                            return [2 /*return*/, resolve(cached)];
                        }
                        request().then((/**
                         * @param {?} response
                         * @return {?}
                         */
                        function (response) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                            return tslib_1.__generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0: return [4 /*yield*/, this.set(key, params, response, configs)];
                                    case 1:
                                        _a.sent();
                                        return [2 /*return*/, resolve(response)];
                                }
                            });
                        }); }));
                        return [2 /*return*/];
                }
            });
        }); }));
    };
    /**
     * @param {?} key
     * @param {?} configs
     * @return {?}
     */
    AOCacheService.prototype.get = /**
     * @param {?} key
     * @param {?} configs
     * @return {?}
     */
    function (key, configs) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var response, response_updated_at;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        console.log('Cache::get', key);
                        response = this._storage.retrieve(key);
                        response_updated_at = this._storage.retrieve(key + '_updated_at');
                        if (response != null
                            && response_updated_at != null
                            && (Date.now() - response_updated_at) <= configs.expire) {
                            return [2 /*return*/, JSON.parse(response)];
                        }
                        return [4 /*yield*/, this.getInServer(key, configs)];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    /**
     * @param {?} key
     * @param {?} configs
     * @return {?}
     */
    AOCacheService.prototype.getInServer = /**
     * @param {?} key
     * @param {?} configs
     * @return {?}
     */
    function (key, configs) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var cached, e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        cached = null;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this._db.query((/**
                             * @param {?} q
                             * @return {?}
                             */
                            function (q) { return q.Get(q.Match(q.Index('cache_by_key'), key)); }))];
                    case 2:
                        cached = _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        e_1 = _a.sent();
                        return [2 /*return*/, null];
                    case 4:
                        this._storage.store(key, cached.data.response);
                        this._storage.store(key + '_updated_at', cached.data.updated_at);
                        if ((Date.now() - cached.data.updated_at) > configs.expire) {
                            return [2 /*return*/, null];
                        }
                        return [2 /*return*/, JSON.parse(cached.data.response)];
                }
            });
        });
    };
    /**
     * @param {?} key
     * @param {?} request
     * @param {?} response
     * @param {?} configs
     * @return {?}
     */
    AOCacheService.prototype.set = /**
     * @param {?} key
     * @param {?} request
     * @param {?} response
     * @param {?} configs
     * @return {?}
     */
    function (key, request, response, configs) {
        /** @type {?} */
        var data = {
            key: key,
            request: request,
            response: JSON.stringify(response),
            updated_at: Date.now(),
            metadata: configs.metadata
        };
        this._storage.store(key, data.response);
        this._storage.store(key + '_updated_at', data.updated_at);
        return this.setInServer(key, data);
    };
    /**
     * @param {?} key
     * @param {?} data
     * @return {?}
     */
    AOCacheService.prototype.setInServer = /**
     * @param {?} key
     * @param {?} data
     * @return {?}
     */
    function (key, data) {
        return this._db.query((/**
         * @param {?} q
         * @return {?}
         */
        function (q) { return q.If(q.Exists(q.Match(q.Index('cache_by_key'), key)), q.Update(q.Select(['ref'], q.Get(q.Match(q.Index('cache_by_key'), key))), { data: tslib_1.__assign({}, data) }), q.Create(q.Collection('cache'), { data: tslib_1.__assign({}, data, { created_at: Date.now() }) })); }));
    };
    return AOCacheService;
}());
// @Injectable({
//   providedIn: 'root'
// })
export { AOCacheService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AOCacheService.prototype._configs;
    /**
     * @type {?}
     * @private
     */
    AOCacheService.prototype._db;
    /**
     * @type {?}
     * @private
     */
    AOCacheService.prototype._storage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW8tY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FvLWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvYW8tY2FjaGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sUUFBUSxDQUFDOzs7O0FBTzdCOzs7OztJQVFFLHdCQUNVLEdBQXFCLEVBQ3JCLFFBQTZCO1FBRDdCLFFBQUcsR0FBSCxHQUFHLENBQWtCO1FBQ3JCLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBUi9CLGFBQVEsR0FBUTtZQUN0QixJQUFJLEVBQUUsTUFBTTs7WUFDWixNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQy9CLFFBQVEsRUFBRSxFQUFFO1NBQ2IsQ0FBQztJQU1GLENBQUM7Ozs7Ozs7SUFFRCw2QkFBSTs7Ozs7O0lBQUosVUFBSyxNQUFXLEVBQUUsT0FBMkIsRUFBRSxPQUFpQjtRQUFoRSxpQkFvQkM7UUFwQjhDLHdCQUFBLEVBQUEsWUFBaUI7UUFFOUQsT0FBTyxHQUFHLENBQUMsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxzQkFBSyxJQUFJLENBQUMsUUFBUSxFQUFLLE9BQU8sRUFBRSxDQUFDLHNCQUFLLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU5RixPQUFPLElBQUksT0FBTzs7Ozs7UUFBQyxVQUFPLE9BQU8sRUFBRSxNQUFNOzs7Ozs7d0JBRXZDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUMxQixHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7d0JBRWhCLHFCQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxFQUFBOzt3QkFBckMsTUFBTSxHQUFHLFNBQTRCO3dCQUMz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QUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTFELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDckMsQ0FBQzs7Ozs7O0lBRUQsb0NBQVc7Ozs7O0lBQVgsVUFBWSxHQUFHLEVBQUUsSUFBSTtRQUNuQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSzs7OztRQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLEVBQUUsQ0FDN0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsRUFDL0MsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUMsSUFBSSx1QkFBTSxJQUFJLENBQUMsRUFBQyxDQUFDLEVBQzVGLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFDLElBQUksdUJBQU0sSUFBSSxJQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUMsRUFBQyxDQUFDLENBQzNFLEVBSjBCLENBSTFCLEVBQUMsQ0FBQztJQUNMLENBQUM7SUFFSCxxQkFBQztBQUFELENBQUMsQUEvRkQsSUErRkM7Ozs7Ozs7Ozs7SUE3RkMsa0NBSUU7Ozs7O0lBR0EsNkJBQTZCOzs7OztJQUM3QixrQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IExvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICduZ3gtd2Vic3RvcmFnZSc7XHJcbmltcG9ydCB7IE1kNSB9IGZyb20gJ3RzLW1kNSc7XHJcblxyXG5pbXBvcnQgeyBBT0ZhdW5hRGJTZXJ2aWNlIH0gZnJvbSAnLi9hby1mYXVuYS1kYi5zZXJ2aWNlJztcclxuXHJcbi8vIEBJbmplY3RhYmxlKHtcclxuLy8gICBwcm92aWRlZEluOiAncm9vdCdcclxuLy8gfSlcclxuZXhwb3J0IGNsYXNzIEFPQ2FjaGVTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBfY29uZmlnczogYW55ID0ge1xyXG4gICAgdHlwZTogJ2Z1bGwnLCAvLyBub25lfGxvY2FsfHNlcnZlcnxmdWxsXHJcbiAgICBleHBpcmU6ICgoMjQgKiA2MCAqIDYwKSAqIDEwMDApLFxyXG4gICAgbWV0YWRhdGE6IHt9LFxyXG4gIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBfZGI6IEFPRmF1bmFEYlNlcnZpY2UsXHJcbiAgICBwcml2YXRlIF9zdG9yYWdlOiBMb2NhbFN0b3JhZ2VTZXJ2aWNlLFxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgZmluZChwYXJhbXM6IGFueSwgcmVxdWVzdDogKCkgPT4gUHJvbWlzZTxhbnk+LCBjb25maWdzOiBhbnkgPSB7fSkge1xyXG5cclxuICAgIGNvbmZpZ3MgPSAodHlwZW9mIGNvbmZpZ3MgPT09ICdvYmplY3QnKSA/IHsuLi50aGlzLl9jb25maWdzLCAuLi5jb25maWdzfSA6IHsuLi50aGlzLl9jb25maWdzfTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG5cclxuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTtcclxuICAgICAgY29uc3Qga2V5ID0gTWQ1Lmhhc2hTdHIocGFyYW1zKTtcclxuXHJcbiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHRoaXMuZ2V0KGtleSwgY29uZmlncyk7XHJcbiAgICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZShjYWNoZWQpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXF1ZXN0KCkudGhlbihhc3luYyByZXNwb25zZSA9PiB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5zZXQoa2V5LCBwYXJhbXMsIHJlc3BvbnNlLCBjb25maWdzKTtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXNwb25zZSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0KGtleSwgY29uZmlnczogYW55KSB7XHJcbiAgICBjb25zb2xlLmxvZygnQ2FjaGU6OmdldCcsIGtleSk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSB0aGlzLl9zdG9yYWdlLnJldHJpZXZlKGtleSk7XHJcbiAgICBjb25zdCByZXNwb25zZV91cGRhdGVkX2F0ID0gdGhpcy5fc3RvcmFnZS5yZXRyaWV2ZShrZXkgKyAnX3VwZGF0ZWRfYXQnKTtcclxuXHJcbiAgICBpZiAoXHJcbiAgICAgIHJlc3BvbnNlICE9IG51bGxcclxuICAgICAgJiYgcmVzcG9uc2VfdXBkYXRlZF9hdCAhPSBudWxsXHJcbiAgICAgICYmIChEYXRlLm5vdygpIC0gcmVzcG9uc2VfdXBkYXRlZF9hdCkgPD0gY29uZmlncy5leHBpcmVcclxuICAgICkge1xyXG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXNwb25zZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0SW5TZXJ2ZXIoa2V5LCBjb25maWdzKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldEluU2VydmVyKGtleSwgY29uZmlnczogYW55KSB7XHJcbiAgICBsZXQgY2FjaGVkID0gbnVsbDtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjYWNoZWQgPSBhd2FpdCB0aGlzLl9kYi5xdWVyeShxID0+IHEuR2V0KHEuTWF0Y2gocS5JbmRleCgnY2FjaGVfYnlfa2V5JyksIGtleSkpKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fc3RvcmFnZS5zdG9yZShrZXksIGNhY2hlZC5kYXRhLnJlc3BvbnNlKTtcclxuICAgIHRoaXMuX3N0b3JhZ2Uuc3RvcmUoa2V5ICsgJ191cGRhdGVkX2F0JywgY2FjaGVkLmRhdGEudXBkYXRlZF9hdCk7XHJcblxyXG4gICAgaWYgKChEYXRlLm5vdygpIC0gY2FjaGVkLmRhdGEudXBkYXRlZF9hdCkgPiBjb25maWdzLmV4cGlyZSkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShjYWNoZWQuZGF0YS5yZXNwb25zZSk7XHJcbiAgfVxyXG5cclxuICBzZXQoa2V5LCByZXF1ZXN0LCByZXNwb25zZSwgY29uZmlnczogYW55KSB7XHJcbiAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICBrZXksXHJcbiAgICAgIHJlcXVlc3QsXHJcbiAgICAgIHJlc3BvbnNlOiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXHJcbiAgICAgIHVwZGF0ZWRfYXQ6IERhdGUubm93KCksXHJcbiAgICAgIG1ldGFkYXRhOiBjb25maWdzLm1ldGFkYXRhXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuX3N0b3JhZ2Uuc3RvcmUoa2V5LCBkYXRhLnJlc3BvbnNlKTtcclxuICAgIHRoaXMuX3N0b3JhZ2Uuc3RvcmUoa2V5ICsgJ191cGRhdGVkX2F0JywgZGF0YS51cGRhdGVkX2F0KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5zZXRJblNlcnZlcihrZXksIGRhdGEpO1xyXG4gIH1cclxuXHJcbiAgc2V0SW5TZXJ2ZXIoa2V5LCBkYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fZGIucXVlcnkocSA9PiBxLklmKFxyXG4gICAgICBxLkV4aXN0cyhxLk1hdGNoKHEuSW5kZXgoJ2NhY2hlX2J5X2tleScpLCBrZXkpKSxcclxuICAgICAgcS5VcGRhdGUocS5TZWxlY3QoWydyZWYnXSwgcS5HZXQocS5NYXRjaChxLkluZGV4KCdjYWNoZV9ieV9rZXknKSwga2V5KSkpLCB7ZGF0YTogey4uLmRhdGF9fSksXHJcbiAgICAgIHEuQ3JlYXRlKHEuQ29sbGVjdGlvbignY2FjaGUnKSwge2RhdGE6IHsuLi5kYXRhLCBjcmVhdGVkX2F0OiBEYXRlLm5vdygpfX0pXHJcbiAgICApKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==